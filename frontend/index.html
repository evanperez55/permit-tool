<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Permit Assistant - Smart Pricing & Requirements for Contractors</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                        destructive: {
                            DEFAULT: "hsl(0 84.2% 60.2%)",
                            foreground: "hsl(210 40% 98%)",
                        },
                        success: {
                            DEFAULT: "hsl(142.1 76.2% 36.3%)",
                            foreground: "hsl(355.7 100% 97.3%)",
                        }
                    },
                    borderRadius: {
                        lg: "0.5rem",
                        md: "calc(0.5rem - 2px)",
                        sm: "calc(0.5rem - 4px)",
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 222.2 84% 4.9%;
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            --primary: 222.2 47.4% 11.2%;
            --primary-foreground: 210 40% 98%;
            --secondary: 210 40% 96.1%;
            --secondary-foreground: 222.2 47.4% 11.2%;
            --muted: 210 40% 96.1%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 210 40% 96.1%;
            --accent-foreground: 222.2 47.4% 11.2%;
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
        }

        .dark {
            --border: 217.2 32.6% 17.5%;
            --input: 217.2 32.6% 17.5%;
            --ring: 212.7 26.8% 83.9%;
            --background: 222.2 84% 4.9%;
            --foreground: 210 40% 98%;
            --primary: 210 40% 98%;
            --primary-foreground: 222.2 47.4% 11.2%;
            --secondary: 217.2 32.6% 17.5%;
            --secondary-foreground: 210 40% 98%;
            --muted: 217.2 32.6% 17.5%;
            --muted-foreground: 215 20.2% 65.1%;
            --accent: 217.2 32.6% 17.5%;
            --accent-foreground: 210 40% 98%;
            --card: 222.2 84% 4.9%;
            --card-foreground: 210 40% 98%;
        }

        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: linear-gradient(to bottom right, hsl(var(--secondary)), hsl(var(--border)));
            min-height: 100vh;
            color: hsl(var(--foreground));
            transition: background-color 0.3s, color 0.3s;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: hsl(var(--muted));
        }

        ::-webkit-scrollbar-thumb {
            background: hsl(var(--muted-foreground));
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: hsl(var(--primary));
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .animate-slide-in {
            animation: slideIn 0.4s ease-out;
        }

        .animate-pulse-slow {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Button hover effects */
        .btn-primary {
            transition: all 0.2s ease;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.2);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        /* Card hover */
        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.15);
        }

        /* Form focus rings */
        .form-input:focus {
            outline: none;
            border-color: hsl(var(--ring));
            box-shadow: 0 0 0 3px hsl(var(--ring) / 0.1);
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid hsl(var(--muted));
            border-top-color: hsl(var(--primary));
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Badge styles */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.25rem 0.625rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .badge-success {
            background: hsl(142.1 76.2% 36.3% / 0.1);
            color: hsl(142.1 76.2% 36.3%);
        }

        .badge-warning {
            background: hsl(38 92% 50% / 0.1);
            color: hsl(38 92% 30%);
        }

        /* Results content styling */
        .results-content h2 {
            color: hsl(var(--foreground));
            font-size: 1.25rem;
            font-weight: 600;
            margin: 1.5rem 0 0.75rem 0;
            padding-top: 1rem;
            border-top: 1px solid hsl(var(--border));
        }

        .results-content h2:first-child {
            margin-top: 0;
            padding-top: 0;
            border-top: none;
        }

        .results-content ul {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .results-content li {
            margin-bottom: 0.5rem;
            color: hsl(var(--muted-foreground));
        }

        .results-content strong {
            color: hsl(var(--foreground));
            font-weight: 600;
        }

        /* Pricing card styles */
        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .pricing-item {
            background: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: 0.5rem;
            padding: 1rem;
            transition: all 0.2s;
        }

        .pricing-item:hover {
            border-color: hsl(var(--primary));
            box-shadow: 0 2px 8px -2px rgba(0, 0, 0, 0.1);
        }

        /* Autocomplete styles */
        .autocomplete-wrapper {
            position: relative;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 40;
            background: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            box-shadow: 0 8px 24px -4px rgba(0, 0, 0, 0.12);
            max-height: 280px;
            overflow-y: auto;
            display: none;
        }

        .autocomplete-dropdown.visible {
            display: block;
        }

        .autocomplete-option {
            padding: 0.625rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.15s;
        }

        .autocomplete-option:hover,
        .autocomplete-option.highlighted {
            background: hsl(var(--accent));
        }

        .autocomplete-option .city-name {
            font-weight: 500;
            font-size: 0.875rem;
            color: hsl(var(--foreground));
        }

        .autocomplete-option .city-badge {
            font-size: 0.625rem;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-weight: 500;
        }

        .autocomplete-option .badge-verified {
            background: hsl(142.1 76.2% 36.3% / 0.1);
            color: hsl(142.1 76.2% 36.3%);
        }

        .autocomplete-option .badge-estimate {
            background: hsl(38 92% 50% / 0.1);
            color: hsl(38 92% 30%);
        }

        .autocomplete-section-label {
            padding: 0.5rem 1rem 0.25rem;
            font-size: 0.625rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: hsl(var(--muted-foreground));
        }

        /* Saved projects drawer */
        .saved-projects-bar {
            transition: all 0.3s ease;
        }

        .saved-project-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            background: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            color: hsl(var(--foreground));
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .saved-project-chip:hover {
            border-color: hsl(var(--primary));
            box-shadow: 0 2px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .saved-project-chip .delete-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: hsl(0 84.2% 60.2% / 0.1);
            color: hsl(0 84.2% 60.2%);
            font-size: 10px;
            line-height: 1;
            transition: background 0.15s;
        }

        .saved-project-chip .delete-btn:hover {
            background: hsl(0 84.2% 60.2% / 0.25);
        }

        /* Mobile responsive overrides */
        @media (max-width: 640px) {
            .container { padding-left: 1rem; padding-right: 1rem; }
            header h1 { font-size: 1.75rem; }
            header p { font-size: 1rem; }
            .badge { font-size: 0.625rem; padding: 0.2rem 0.5rem; }
            .pricing-grid { grid-template-columns: 1fr 1fr; }
            .pricing-item { padding: 0.75rem; }
            #recommendedCharge { font-size: 2.5rem; }
            .results-content h2 { font-size: 1.1rem; }
            /* Stack action buttons */
            #results > .flex.flex-wrap { flex-direction: column; }
            #results > .flex.flex-wrap > button { min-width: 100%; }
            /* Comparison table scroll */
            table { font-size: 0.8rem; }
            table th, table td { padding: 0.5rem; }
            /* Modal full-screen on mobile */
            #templateModal > div { max-width: 100%; max-height: 100vh; border-radius: 0; }
        }

        @media (max-width: 480px) {
            .pricing-grid { grid-template-columns: 1fr; }
            .grid.grid-cols-2 { grid-template-columns: 1fr; }
        }

        /* Print / PDF export styles */
        @media print {
            body { background: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            #formCard, #comparisonCard, #loading, #templateModal, #savedProjectsBar, .btn-primary, button { display: none !important; }
            #results { display: block !important; }
            #results > div { break-inside: avoid; border: 1px solid #ddd !important; margin-bottom: 1rem; }
            .animate-fade-in, .animate-slide-in { animation: none !important; }
            .card-hover:hover { transform: none; box-shadow: none; }
            header { margin-bottom: 1rem; }
            /* Show print header */
            .print-header { display: block !important; text-align: center; margin-bottom: 1.5rem; border-bottom: 2px solid #222; padding-bottom: 0.75rem; }
            .print-header h2 { font-size: 1.25rem; margin: 0; }
            .print-header p { font-size: 0.75rem; color: #666; margin: 0.25rem 0 0; }
            /* Show action buttons row but hide the buttons */
            #results > .flex.flex-wrap { display: none !important; }
            #results > button { display: none !important; }
        }
        .print-header { display: none; }

        /* Error toast */
        .error-toast {
            position: fixed;
            top: 1.5rem;
            left: 50%;
            transform: translateX(-50%) translateY(-120%);
            z-index: 100;
            max-width: 480px;
            width: calc(100% - 2rem);
            background: hsl(var(--card));
            border: 1px solid hsl(0 84.2% 60.2% / 0.3);
            border-left: 4px solid hsl(0 84.2% 60.2%);
            border-radius: 0.5rem;
            padding: 1rem 1.25rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease;
        }

        .error-toast.visible {
            transform: translateX(-50%) translateY(0);
        }

        /* Dark mode toggle */
        .theme-toggle {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 50;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            box-shadow: 0 2px 10px -2px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: hsl(var(--foreground));
        }

        .theme-toggle:hover {
            box-shadow: 0 4px 16px -4px rgba(0, 0, 0, 0.25);
            transform: scale(1.05);
        }

        /* Dark mode card overrides */
        .dark .bg-white {
            background: hsl(var(--card)) !important;
        }

        .dark .bg-green-50 { background: hsl(142.1 76.2% 36.3% / 0.1) !important; }
        .dark .border-green-200 { border-color: hsl(142.1 76.2% 36.3% / 0.2) !important; }
        .dark .text-green-600 { color: hsl(142.1 70% 50%) !important; }
        .dark .bg-green-100 { background: hsl(142.1 76.2% 36.3% / 0.15) !important; }
        .dark .text-green-800 { color: hsl(142.1 70% 60%) !important; }
        .dark .border-green-300 { border-color: hsl(142.1 76.2% 36.3% / 0.3) !important; }

        .dark .bg-yellow-50 { background: hsl(38 92% 50% / 0.1) !important; }
        .dark .border-yellow-200 { border-color: hsl(38 92% 50% / 0.2) !important; }
        .dark .text-yellow-600 { color: hsl(38 92% 60%) !important; }
        .dark .bg-yellow-100 { background: hsl(38 92% 50% / 0.15) !important; }
        .dark .text-yellow-800 { color: hsl(38 92% 65%) !important; }
        .dark .border-yellow-300 { border-color: hsl(38 92% 50% / 0.3) !important; }
        .dark .text-yellow-900 { color: hsl(38 92% 70%) !important; }
        .dark .bg-yellow-100\/50 { background: hsl(38 92% 50% / 0.08) !important; }

        .dark .bg-amber-50 { background: hsl(38 92% 50% / 0.1) !important; }
        .dark .border-amber-200 { border-color: hsl(38 92% 50% / 0.2) !important; }
        .dark .text-amber-600 { color: hsl(38 92% 60%) !important; }

        .dark .bg-blue-50 { background: hsl(217 91% 60% / 0.1) !important; }
        .dark .border-blue-200 { border-color: hsl(217 91% 60% / 0.2) !important; }
        .dark .text-blue-600 { color: hsl(217 91% 70%) !important; }

        .dark .text-gray-600 { color: hsl(var(--muted-foreground)) !important; }
        .dark .text-gray-700 { color: hsl(var(--foreground)) !important; }

        .dark select, .dark input, .dark textarea {
            background: hsl(var(--secondary)) !important;
            color: hsl(var(--foreground)) !important;
            border-color: hsl(var(--border)) !important;
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <!-- Header -->
        <header class="text-center mb-12 animate-fade-in">
            <div class="inline-flex items-center gap-2 bg-primary text-primary-foreground px-4 py-1.5 rounded-full text-sm font-medium mb-4">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                <span>Powered by Real Permit Data</span>
            </div>
            <h1 class="text-4xl md:text-5xl font-bold text-foreground mb-3">
                Permit Assistant
            </h1>
            <p class="text-xl text-muted-foreground mb-6">
                Know exactly what to charge clients for permit work
            </p>
            <div class="flex flex-wrap justify-center gap-3 text-sm">
                <span class="badge badge-success">
                    <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                    Instant pricing calculations
                </span>
                <span class="badge badge-success">
                    <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                    Labor cost breakdown
                </span>
                <span class="badge badge-success">
                    <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                    Client-ready quotes
                </span>
            </div>
        </header>

        <!-- Saved Projects Bar -->
        <div id="savedProjectsBar" class="hidden saved-projects-bar mb-4 animate-fade-in">
            <div class="bg-white border border-border rounded-lg shadow-sm px-4 py-3">
                <div class="flex items-center gap-3 mb-2">
                    <svg class="w-4 h-4 text-muted-foreground flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                    </svg>
                    <span class="text-sm font-medium text-foreground">Saved Lookups</span>
                    <button onclick="clearAllSavedProjects()" class="ml-auto text-xs text-muted-foreground hover:text-destructive transition-colors">Clear all</button>
                </div>
                <div id="savedProjectsList" class="flex flex-wrap gap-2 overflow-x-auto">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Main Form Card -->
        <div id="formCard" class="bg-white border border-border rounded-lg shadow-sm p-6 md:p-8 mb-6 animate-fade-in card-hover">
            <form id="permitForm" class="space-y-6">
                <div class="space-y-4">
                    <div>
                        <label for="jobType" class="block text-sm font-medium text-foreground mb-2">
                            What type of work are you doing? <span class="text-destructive">*</span>
                        </label>
                        <select id="jobType" required aria-required="true" class="form-input w-full px-4 py-2.5 border border-input rounded-md bg-background text-foreground text-base focus:outline-none focus:ring-2 focus:ring-ring">
                            <option value="">Select job type...</option>
                            <option value="Electrical Work">Electrical Work</option>
                            <option value="Plumbing">Plumbing</option>
                            <option value="HVAC">HVAC</option>
                            <option value="Roofing">Roofing</option>
                            <option value="General Construction">General Construction</option>
                            <option value="Remodeling/Renovation">Remodeling/Renovation</option>
                            <option value="Solar Installation">Solar Installation</option>
                            <option value="Pool/Spa">Pool/Spa</option>
                            <option value="Fence/Deck">Fence/Deck</option>
                            <option value="Demolition">Demolition</option>
                        </select>
                    </div>

                    <div>
                        <label for="cityInput" class="block text-sm font-medium text-foreground mb-2">
                            City <span class="text-destructive">*</span>
                        </label>
                        <div class="autocomplete-wrapper">
                            <div class="relative">
                                <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                                <input type="text" id="cityInput" required aria-required="true" autocomplete="off" placeholder="Type a city name..." role="combobox" aria-expanded="false" aria-controls="cityDropdown" aria-autocomplete="list" class="form-input w-full pl-10 pr-4 py-2.5 border border-input rounded-md bg-background text-foreground text-base focus:outline-none focus:ring-2 focus:ring-ring" />
                            </div>
                            <div id="cityDropdown" class="autocomplete-dropdown" role="listbox" aria-label="City suggestions"></div>
                        </div>
                        <p class="text-xs text-muted-foreground mt-2 flex items-start gap-1">
                            <svg class="w-4 h-4 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                            <span>Verified data for <strong id="cityCount">10</strong> cities. Other cities use regional estimates.</span>
                        </p>
                    </div>
                    <!-- Hidden inputs to maintain compatibility with existing form handler -->
                    <input type="hidden" id="city" value="">
                    <input type="hidden" id="state" value="">

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="projectType" class="block text-sm font-medium text-foreground mb-2">
                                Project Type
                            </label>
                            <select id="projectType" class="form-input w-full px-4 py-2.5 border border-input rounded-md bg-background text-foreground">
                                <option value="Residential">Residential</option>
                                <option value="Commercial">Commercial</option>
                                <option value="Industrial">Industrial</option>
                            </select>
                        </div>

                        <div>
                            <label for="scope" class="block text-sm font-medium text-foreground mb-2">
                                Scope of Work
                            </label>
                            <select id="scope" class="form-input w-full px-4 py-2.5 border border-input rounded-md bg-background text-foreground">
                                <option value="New Installation">New Installation</option>
                                <option value="Repair/Service">Repair/Service</option>
                                <option value="Replacement">Replacement</option>
                                <option value="Renovation">Renovation</option>
                                <option value="Addition">Addition</option>
                            </select>
                        </div>

                        <div>
                            <label for="projectValue" class="block text-sm font-medium text-foreground mb-2">
                                Estimated Project Value
                            </label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground font-medium">$</span>
                                <input type="number" id="projectValue" min="0" step="500" value="5000" placeholder="5000" class="form-input w-full pl-7 pr-4 py-2.5 border border-input rounded-md bg-background text-foreground">
                            </div>
                        </div>
                    </div>

                    <div>
                        <label for="description" class="block text-sm font-medium text-foreground mb-2">
                            Brief Description (Optional)
                        </label>
                        <textarea id="description" rows="3" placeholder="e.g., Installing 200amp service panel upgrade" class="form-input w-full px-4 py-2.5 border border-input rounded-md bg-background text-foreground resize-none"></textarea>
                    </div>
                </div>

                <button type="submit" class="btn-primary w-full bg-primary text-primary-foreground px-6 py-3 rounded-md font-semibold text-base disabled:opacity-50 disabled:cursor-not-allowed">
                    Get Pricing & Requirements
                    <svg class="inline-block w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                    </svg>
                </button>
            </form>
        </div>

        <!-- Jurisdiction Comparison Feature -->
        <div id="comparisonCard" class="bg-white border border-border rounded-lg shadow-sm p-6 mb-6 card-hover">
            <div class="flex items-start justify-between mb-4">
                <div class="flex items-center gap-3">
                    <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    <div>
                        <h3 class="text-lg font-semibold text-foreground">Compare Multiple Jurisdictions</h3>
                        <p class="text-sm text-muted-foreground">See pricing differences across cities you work in</p>
                    </div>
                </div>
                <button onclick="toggleComparison()" id="toggleComparisonBtn" class="btn-primary px-4 py-2 bg-primary text-primary-foreground rounded-md font-medium text-sm" aria-expanded="false" aria-controls="comparisonPanel">
                    <span id="toggleBtnText">Compare Cities</span>
                    <svg id="toggleBtnIcon" class="inline-block w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
            </div>

            <!-- Comparison Panel (Hidden by default) -->
            <div id="comparisonPanel" class="hidden mt-6 pt-6 border-t border-border">
                <div class="space-y-6">
                    <!-- Jurisdiction Selection -->
                    <div>
                        <label class="block text-sm font-medium text-foreground mb-3">
                            Select Jurisdictions to Compare (2-5 cities)
                        </label>
                        <div id="jurisdictionCheckboxes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                            <!-- Populated dynamically -->
                        </div>
                    </div>

                    <!-- Job Type for Comparison -->
                    <div>
                        <label for="comparisonJobType" class="block text-sm font-medium text-foreground mb-2">
                            Job Type <span class="text-destructive">*</span>
                        </label>
                        <select id="comparisonJobType" class="form-input w-full px-4 py-2.5 border border-input rounded-md bg-background text-foreground">
                            <option value="">Select job type...</option>
                            <option value="Electrical">Electrical</option>
                            <option value="Plumbing">Plumbing</option>
                            <option value="HVAC">HVAC</option>
                            <option value="General Construction">General Construction</option>
                            <option value="Remodeling">Remodeling</option>
                            <option value="Solar">Solar</option>
                            <option value="Roofing">Roofing</option>
                            <option value="Pool">Pool</option>
                            <option value="Fence">Fence</option>
                            <option value="Demolition">Demolition</option>
                        </select>
                    </div>

                    <!-- Compare Button -->
                    <button onclick="compareJurisdictions()" id="compareBtn" class="btn-primary w-full bg-primary text-primary-foreground px-6 py-3 rounded-md font-semibold disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg class="inline-block w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                        Compare Selected Cities
                    </button>
                </div>

                <!-- Comparison Results -->
                <div id="comparisonResults" class="hidden mt-8 pt-8 border-t border-border">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="hidden bg-white border border-border rounded-lg shadow-sm p-12 text-center animate-fade-in" aria-live="polite">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-foreground font-medium mb-2">Analyzing permit requirements & calculating pricing...</p>
            <p class="text-muted-foreground text-sm">This should only take a moment</p>
        </div>

        <!-- Results Section -->
        <div id="results" class="hidden space-y-6" aria-live="polite">
            <!-- Print-only header -->
            <div class="print-header">
                <h2>Permit Assistant Report</h2>
                <p id="printMeta"></p>
            </div>
            <!-- Pricing Calculator Card (Main Feature) -->
            <div class="bg-white border-2 border-primary rounded-lg shadow-lg p-6 animate-fade-in">
                <div class="flex items-start justify-between mb-6">
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <h2 class="text-2xl font-bold text-foreground">What to Charge Your Client</h2>
                        </div>
                        <p class="text-muted-foreground text-sm" id="pricingLocation"></p>
                    </div>
                    <span class="badge badge-success">Recommended</span>
                </div>

                <!-- Data Quality Indicator -->
                <div id="dataQualityIndicator" class="mb-6">
                    <!-- Will be populated dynamically -->
                </div>

                <!-- Big Number Display -->
                <div class="bg-accent/50 border border-border rounded-lg p-6 mb-6 text-center">
                    <p class="text-sm font-medium text-muted-foreground mb-2">Recommended Charge</p>
                    <p class="text-5xl font-bold text-foreground mb-2" id="recommendedCharge">$0</p>
                    <div class="flex items-center justify-center gap-4 text-sm">
                        <span class="text-muted-foreground">
                            Your profit: <strong class="text-success" id="yourProfit">$0</strong>
                        </span>
                        <span class="text-muted-foreground">â€¢</span>
                        <span class="text-muted-foreground">
                            <strong id="profitMargin">0</strong>% margin
                        </span>
                    </div>
                </div>

                <!-- Cost Breakdown -->
                <div class="space-y-4 mb-6">
                    <h3 class="font-semibold text-foreground flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                        Cost Breakdown
                    </h3>
                    <div class="pricing-grid" id="costBreakdown">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>

                <!-- Labor Time Breakdown -->
                <div class="bg-muted rounded-lg p-4">
                    <h4 class="font-semibold text-sm text-foreground mb-3">Time Investment</h4>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3 text-sm" id="laborBreakdown">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
            </div>

            <!-- Competitive Intelligence -->
            <div class="bg-white border border-border rounded-lg shadow-sm p-6 animate-fade-in">
                <h3 class="font-semibold text-foreground flex items-center gap-2 mb-4">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                    </svg>
                    Competitive Intelligence
                </h3>
                <div class="space-y-3" id="competitiveInfo">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <!-- Client Communication Templates -->
            <div class="bg-white border border-border rounded-lg shadow-sm p-6 animate-fade-in">
                <h3 class="font-semibold text-foreground flex items-center gap-2 mb-4">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                    </svg>
                    Client Communication Templates
                </h3>
                <p class="text-sm text-muted-foreground mb-4">
                    Professional templates to help you justify permit costs and compete against unlicensed workers
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="clientTemplates">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <!-- Required Paperwork -->
            <div class="bg-white border border-border rounded-lg shadow-sm p-6 animate-fade-in">
                <h3 class="font-semibold text-foreground flex items-center gap-2 mb-4">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Required Paperwork
                    <span id="paperworkBadge" class="ml-2 px-2 py-0.5 bg-primary text-primary-foreground text-xs font-medium rounded-full"></span>
                </h3>
                <p class="text-sm text-muted-foreground mb-4">
                    Direct links to official permit forms and documents - verified current as of the dates shown
                </p>

                <!-- Prep Time Estimate -->
                <div id="prepTimeEstimate" class="bg-muted/30 border border-border rounded-md p-4 mb-4">
                    <!-- Will be populated dynamically -->
                </div>

                <!-- Applications -->
                <div id="paperworkApplications" class="mb-4">
                    <!-- Will be populated dynamically -->
                </div>

                <!-- Supporting Documents -->
                <div id="paperworkSupporting" class="mb-4">
                    <!-- Will be populated dynamically -->
                </div>

                <!-- Fee Schedules -->
                <div id="paperworkFeeSchedules" class="mb-4">
                    <!-- Will be populated dynamically -->
                </div>

                <!-- Helpful Tips -->
                <div id="paperworkTips" class="bg-blue-50 border border-blue-200 rounded-md p-4">
                    <!-- Will be populated dynamically -->
                </div>

                <!-- Report Broken Link -->
                <div class="mt-4 pt-4 border-t border-border">
                    <p class="text-xs text-muted-foreground">
                        Found a broken link or outdated form?
                        <button onclick="showReportLinkModal()" class="text-primary hover:underline font-medium">
                            Report it here
                        </button>
                    </p>
                </div>
            </div>

            <!-- Inspection Checklist -->
            <div class="bg-white border border-border rounded-lg shadow-sm p-6 animate-fade-in">
                <div class="flex items-start justify-between mb-4">
                    <h3 class="font-semibold text-foreground flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                        </svg>
                        Inspection Checklist
                    </h3>
                    <div class="text-right">
                        <span id="inspectionProgress" class="text-sm font-medium text-muted-foreground">0 / 0</span>
                        <div class="w-24 h-2 bg-muted rounded-full mt-1 overflow-hidden">
                            <div id="inspectionProgressBar" class="h-full bg-success rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <p class="text-sm text-muted-foreground mb-4">
                    Track your inspections as you complete them. Progress is saved automatically.
                </p>
                <div id="inspectionChecklist" class="space-y-2">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <!-- Permit Requirements -->
            <div class="bg-white border border-border rounded-lg shadow-sm p-6 animate-fade-in">
                <h3 class="font-semibold text-foreground flex items-center gap-2 mb-4">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Detailed Permit Requirements
                </h3>
                <div class="results-content prose max-w-none" id="requirementsContent">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-wrap gap-3">
                <button onclick="saveCurrentProject()" id="saveProjectBtn" class="flex-1 min-w-[140px] bg-primary text-primary-foreground px-4 py-2.5 rounded-md font-medium text-sm hover:bg-primary/90 transition-colors">
                    <svg class="inline-block w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                    </svg>
                    Save Lookup
                </button>
                <button onclick="printReport()" class="flex-1 min-w-[140px] bg-secondary text-secondary-foreground px-4 py-2.5 rounded-md font-medium text-sm hover:bg-secondary/80 transition-colors" title="Use 'Save as PDF' in the print dialog to download">
                    <svg class="inline-block w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Save as PDF
                </button>
                <button onclick="emailResults()" class="flex-1 min-w-[140px] bg-secondary text-secondary-foreground px-4 py-2.5 rounded-md font-medium text-sm hover:bg-secondary/80 transition-colors">
                    <svg class="inline-block w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    Email
                </button>
                <button onclick="copyToClipboard()" class="flex-1 min-w-[140px] bg-secondary text-secondary-foreground px-4 py-2.5 rounded-md font-medium text-sm hover:bg-secondary/80 transition-colors">
                    <svg class="inline-block w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                    Copy
                </button>
            </div>

            <!-- Reset Button -->
            <button onclick="resetForm()" class="w-full bg-secondary text-secondary-foreground px-4 py-3 rounded-md font-medium hover:bg-secondary/80 transition-colors">
                Check Another Permit
            </button>
        </div>
    </div>

    <!-- Template Modal -->
    <div id="templateModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 animate-fade-in" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="bg-white rounded-lg shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b border-border">
                <h3 class="text-xl font-bold text-foreground" id="modalTitle">Template</h3>
                <button onclick="closeModal()" class="text-muted-foreground hover:text-foreground transition-colors" aria-label="Close modal">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-140px)]">
                <textarea id="modalContent" class="w-full h-96 p-4 border border-input rounded-md font-mono text-sm bg-muted/30" readonly></textarea>
            </div>
            <div class="flex gap-3 p-6 border-t border-border bg-muted/30">
                <button onclick="copyTemplate()" class="flex-1 bg-primary text-primary-foreground px-4 py-2.5 rounded-md font-medium hover:bg-primary/90 transition-colors">
                    <svg class="inline-block w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                    Copy to Clipboard
                </button>
                <button onclick="emailTemplate()" class="flex-1 bg-secondary text-secondary-foreground px-4 py-2.5 rounded-md font-medium hover:bg-secondary/80 transition-colors">
                    <svg class="inline-block w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    Email This
                </button>
            </div>
        </div>
    </div>

    <!-- Error Toast -->
    <div id="errorToast" class="error-toast" role="alert">
        <div class="flex items-start gap-3">
            <svg class="w-5 h-5 text-destructive flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            </svg>
            <div class="flex-1">
                <p class="text-sm font-semibold text-foreground" id="errorToastTitle">Error</p>
                <p class="text-sm text-muted-foreground mt-1" id="errorToastMessage"></p>
            </div>
            <button onclick="hideError()" class="text-muted-foreground hover:text-foreground transition-colors flex-shrink-0" aria-label="Dismiss notification">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Dark Mode Toggle -->
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode" id="themeToggle" aria-label="Toggle dark mode">
        <svg id="sunIcon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
        </svg>
        <svg id="moonIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
        </svg>
    </button>

    <script>
        const API_BASE = window.PERMIT_API_URL || 'http://localhost:5001';
        const API_URL = API_BASE + '/api/check-requirements';
        let currentData = null;
        let currentTemplate = null;
        let verifiedCities = [];
        let highlightedIndex = -1;
        let errorTimeout = null;

        // ============================================
        // DARK MODE
        // ============================================

        function getThemePreference() {
            const stored = localStorage.getItem('permit-assistant-theme');
            if (stored) return stored;
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        function applyTheme(theme) {
            document.documentElement.classList.toggle('dark', theme === 'dark');
            document.getElementById('sunIcon').classList.toggle('hidden', theme === 'light');
            document.getElementById('moonIcon').classList.toggle('hidden', theme === 'dark');
        }

        function toggleTheme() {
            const current = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            const next = current === 'dark' ? 'light' : 'dark';
            localStorage.setItem('permit-assistant-theme', next);
            applyTheme(next);
        }

        // Apply theme immediately
        applyTheme(getThemePreference());

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (!localStorage.getItem('permit-assistant-theme')) {
                applyTheme(e.matches ? 'dark' : 'light');
            }
        });

        // ============================================
        // ERROR TOAST
        // ============================================

        function showError(title, message) {
            const toast = document.getElementById('errorToast');
            document.getElementById('errorToastTitle').textContent = title;
            document.getElementById('errorToastMessage').textContent = message;
            toast.classList.add('visible');

            if (errorTimeout) clearTimeout(errorTimeout);
            errorTimeout = setTimeout(() => hideError(), 8000);
        }

        function hideError() {
            document.getElementById('errorToast').classList.remove('visible');
            if (errorTimeout) { clearTimeout(errorTimeout); errorTimeout = null; }
        }

        function showSuccess(message) {
            const toast = document.getElementById('errorToast');
            const icon = toast.querySelector('svg');
            icon.setAttribute('class', 'w-5 h-5 text-success flex-shrink-0 mt-0.5');
            icon.innerHTML = '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>';
            toast.style.borderLeftColor = 'hsl(142.1, 76.2%, 36.3%)';
            toast.style.borderColor = 'hsl(142.1 76.2% 36.3% / 0.3)';
            document.getElementById('errorToastTitle').textContent = 'Success';
            document.getElementById('errorToastMessage').textContent = message;
            toast.classList.add('visible');

            if (errorTimeout) clearTimeout(errorTimeout);
            errorTimeout = setTimeout(() => {
                hideError();
                // Reset to error styling
                icon.setAttribute('class', 'w-5 h-5 text-destructive flex-shrink-0 mt-0.5');
                icon.innerHTML = '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>';
                toast.style.borderLeftColor = '';
                toast.style.borderColor = '';
            }, 4000);
        }

        const form = document.getElementById('permitForm');
        const formCard = document.getElementById('formCard');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');

        // US states for autocomplete fallback
        const US_STATES = {
            'AL':'Alabama','AK':'Alaska','AZ':'Arizona','AR':'Arkansas','CA':'California',
            'CO':'Colorado','CT':'Connecticut','DE':'Delaware','FL':'Florida','GA':'Georgia',
            'HI':'Hawaii','ID':'Idaho','IL':'Illinois','IN':'Indiana','IA':'Iowa',
            'KS':'Kansas','KY':'Kentucky','LA':'Louisiana','ME':'Maine','MD':'Maryland',
            'MA':'Massachusetts','MI':'Michigan','MN':'Minnesota','MS':'Mississippi','MO':'Missouri',
            'MT':'Montana','NE':'Nebraska','NV':'Nevada','NH':'New Hampshire','NJ':'New Jersey',
            'NM':'New Mexico','NY':'New York','NC':'North Carolina','ND':'North Dakota','OH':'Ohio',
            'OK':'Oklahoma','OR':'Oregon','PA':'Pennsylvania','RI':'Rhode Island','SC':'South Carolina',
            'SD':'South Dakota','TN':'Tennessee','TX':'Texas','UT':'Utah','VT':'Vermont',
            'VA':'Virginia','WA':'Washington','WV':'West Virginia','WI':'Wisconsin','WY':'Wyoming'
        };

        // Load verified cities on page load
        async function loadVerifiedCities() {
            try {
                const response = await fetch(API_BASE + '/api/verified-cities');
                const data = await response.json();

                if (data.success) {
                    verifiedCities = data.cities;
                    document.getElementById('cityCount').textContent = data.count;
                }
            } catch (error) {
                console.error('Failed to load verified cities:', error);
            }
        }

        // ============================================
        // AUTOCOMPLETE
        // ============================================

        const cityInput = document.getElementById('cityInput');
        const cityDropdown = document.getElementById('cityDropdown');

        function setCityFromSelection(cityName) {
            cityInput.value = cityName;
            const parts = cityName.split(', ');
            document.getElementById('city').value = parts[0];
            document.getElementById('state').value = parts[1] || '';
            cityDropdown.classList.remove('visible');
            cityInput.setAttribute('aria-expanded', 'false');
            highlightedIndex = -1;
        }

        function renderAutocomplete(query) {
            const q = query.trim().toLowerCase();
            if (q.length === 0) {
                cityDropdown.classList.remove('visible');
                return;
            }

            let html = '';
            const matchedVerified = verifiedCities.filter(c =>
                c.name.toLowerCase().includes(q)
            );

            if (matchedVerified.length > 0) {
                html += '<div class="autocomplete-section-label">Verified Cities</div>';
                matchedVerified.forEach((city, i) => {
                    html += `<div class="autocomplete-option" data-value="${city.name}" data-index="${i}">
                        <span class="city-name">${highlightMatch(city.name, q)}</span>
                        <span class="city-badge badge-verified">Verified</span>
                    </div>`;
                });
            }

            // Generate suggestions from state abbreviations
            const stateMatches = [];
            for (const [abbr, name] of Object.entries(US_STATES)) {
                if (name.toLowerCase().includes(q) || abbr.toLowerCase().includes(q)) {
                    // Check if we already have this state in verified
                    const alreadyListed = matchedVerified.some(c => c.name.endsWith(`, ${abbr}`));
                    if (!alreadyListed) {
                        stateMatches.push({ abbr, name });
                    }
                }
            }

            // If query looks like "City, ST" parse it
            const commaMatch = q.match(/^(.+),\s*([a-z]{0,2})$/i);
            if (commaMatch) {
                const typedCity = commaMatch[1].trim();
                const typedState = commaMatch[2].trim().toUpperCase();
                if (typedState && US_STATES[typedState]) {
                    const suggestion = `${typedCity.charAt(0).toUpperCase() + typedCity.slice(1)}, ${typedState}`;
                    const alreadyExists = matchedVerified.some(c => c.name.toLowerCase() === suggestion.toLowerCase());
                    if (!alreadyExists) {
                        html += '<div class="autocomplete-section-label">Use Regional Estimate</div>';
                        html += `<div class="autocomplete-option" data-value="${suggestion}" data-index="${matchedVerified.length}">
                            <span class="city-name">${suggestion}</span>
                            <span class="city-badge badge-estimate">Estimate</span>
                        </div>`;
                    }
                }
            }

            if (html === '') {
                html = '<div class="autocomplete-section-label">Type "City, ST" (e.g. Denver, CO)</div>';
            }

            cityDropdown.innerHTML = html;
            cityDropdown.classList.add('visible');
            cityInput.setAttribute('aria-expanded', 'true');
            highlightedIndex = -1;

            // Attach click handlers and ARIA roles
            cityDropdown.querySelectorAll('.autocomplete-option').forEach(opt => {
                opt.setAttribute('role', 'option');
                opt.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    setCityFromSelection(opt.dataset.value);
                });
            });
        }

        function highlightMatch(text, query) {
            const idx = text.toLowerCase().indexOf(query);
            if (idx === -1) return text;
            return text.slice(0, idx) + '<strong>' + text.slice(idx, idx + query.length) + '</strong>' + text.slice(idx + query.length);
        }

        cityInput.addEventListener('input', () => renderAutocomplete(cityInput.value));

        cityInput.addEventListener('focus', () => {
            if (cityInput.value.trim().length > 0) {
                renderAutocomplete(cityInput.value);
            } else if (verifiedCities.length > 0) {
                // Show all verified cities when focusing empty input
                let html = '<div class="autocomplete-section-label">Verified Cities</div>';
                verifiedCities.forEach((city, i) => {
                    html += `<div class="autocomplete-option" data-value="${city.name}" data-index="${i}">
                        <span class="city-name">${city.name}</span>
                        <span class="city-badge badge-verified">Verified</span>
                    </div>`;
                });
                cityDropdown.innerHTML = html;
                cityDropdown.classList.add('visible');
                cityInput.setAttribute('aria-expanded', 'true');
                cityDropdown.querySelectorAll('.autocomplete-option').forEach(opt => {
                    opt.setAttribute('role', 'option');
                    opt.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        setCityFromSelection(opt.dataset.value);
                    });
                });
            }
        });

        cityInput.addEventListener('blur', () => {
            setTimeout(() => {
                cityDropdown.classList.remove('visible');
                cityInput.setAttribute('aria-expanded', 'false');
                // Auto-parse city/state from typed value
                const val = cityInput.value.trim();
                if (val && val.includes(',')) {
                    const parts = val.split(',').map(s => s.trim());
                    document.getElementById('city').value = parts[0];
                    document.getElementById('state').value = parts[1] || '';
                }
            }, 150);
        });

        cityInput.addEventListener('keydown', (e) => {
            const options = cityDropdown.querySelectorAll('.autocomplete-option');
            if (!cityDropdown.classList.contains('visible') || options.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                highlightedIndex = Math.min(highlightedIndex + 1, options.length - 1);
                updateHighlight(options);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                highlightedIndex = Math.max(highlightedIndex - 1, 0);
                updateHighlight(options);
            } else if (e.key === 'Enter' && highlightedIndex >= 0) {
                e.preventDefault();
                setCityFromSelection(options[highlightedIndex].dataset.value);
            } else if (e.key === 'Escape') {
                cityDropdown.classList.remove('visible');
            }
        });

        function updateHighlight(options) {
            options.forEach((opt, i) => {
                opt.classList.toggle('highlighted', i === highlightedIndex);
                if (i === highlightedIndex) opt.scrollIntoView({ block: 'nearest' });
            });
        }

        // Load cities when page loads
        loadVerifiedCities();
        loadSavedProjects();

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                jobType: document.getElementById('jobType').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                projectType: document.getElementById('projectType').value,
                scope: document.getElementById('scope').value,
                description: document.getElementById('description').value,
                projectValue: Number(document.getElementById('projectValue').value) || 5000
            };

            // Show loading
            formCard.classList.add('hidden');
            loading.classList.remove('hidden');
            results.classList.add('hidden');

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    currentData = result;
                    displayResults(result);

                    loading.classList.add('hidden');
                    results.classList.remove('hidden');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    throw new Error(result.error || 'Failed to get requirements');
                }
            } catch (error) {
                showError('Connection Error', error.message + ' â€” Make sure the backend server is running on port 5001.');
                formCard.classList.remove('hidden');
                loading.classList.add('hidden');
            }
        });

        function displayResults(data) {
            const { pricing, clientExplanation, requirements, metadata, clientTemplates } = data;

            // Location
            document.getElementById('pricingLocation').textContent = `${metadata.jobType} in ${metadata.location}`;

            // Data Quality Indicator
            displayDataQuality(pricing.dataQuality);

            // Main pricing
            document.getElementById('recommendedCharge').textContent = `$${pricing.summary.recommendedCharge.toLocaleString()}`;
            document.getElementById('yourProfit').textContent = `$${pricing.summary.yourProfit.toLocaleString()}`;
            document.getElementById('profitMargin').textContent = pricing.summary.profitMargin;

            // Cost breakdown
            const costBreakdown = document.getElementById('costBreakdown');
            costBreakdown.innerHTML = clientExplanation.breakdown.map(item => `
                <div class="pricing-item">
                    <p class="text-xs text-muted-foreground mb-1">${item.item}</p>
                    <p class="text-lg font-bold text-foreground">$${item.cost}</p>
                    <p class="text-xs text-muted-foreground mt-1">${item.description}</p>
                </div>
            `).join('');

            // Labor breakdown
            const laborBreakdown = document.getElementById('laborBreakdown');
            const labor = pricing.labor.breakdown;
            laborBreakdown.innerHTML = Object.entries(labor).map(([key, value]) => `
                <div class="flex items-center justify-between">
                    <span class="text-muted-foreground capitalize">${key.replace(/([A-Z])/g, ' $1').trim()}:</span>
                    <span class="font-semibold text-foreground">${value.hours}h</span>
                </div>
            `).join('');

            // Competitive info
            const competitive = document.getElementById('competitiveInfo');
            competitive.innerHTML = `
                <div class="flex items-center justify-between p-3 bg-destructive/10 rounded-md">
                    <span class="text-sm font-medium">Unlicensed contractor might charge:</span>
                    <span class="font-semibold text-destructive">~$${pricing.competitive.unlicensedContractorPrice}</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-muted rounded-md">
                    <span class="text-sm font-medium">Permit expediter service:</span>
                    <span class="font-semibold">~$${pricing.competitive.expediterServicePrice}</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-success/10 rounded-md">
                    <span class="text-sm font-medium">Your competitive price:</span>
                    <span class="font-semibold text-success">$${pricing.summary.recommendedCharge}</span>
                </div>
                <p class="text-xs text-muted-foreground mt-2">
                    ðŸ’¡ <strong>Your advantage:</strong> ${pricing.competitive.yourAdvantage}
                </p>
            `;

            // Client templates
            const templatesContainer = document.getElementById('clientTemplates');
            const templates = [
                { key: 'professionalQuote', title: 'Professional Quote', icon: 'ðŸ’°', desc: 'Complete pricing breakdown for client' },
                { key: 'permitValue', title: 'Permit Value Email', icon: 'âœ…', desc: 'Explain why permits matter' },
                { key: 'permitExplainer', title: 'Quick Explainer', icon: 'ðŸ“š', desc: 'Simple guide for clients' },
                { key: 'comparisonSheet', title: 'Licensed vs Unlicensed', icon: 'âš–ï¸', desc: 'Show the real comparison' },
                { key: 'paymentOptions', title: 'Payment Plans', icon: 'ðŸ’³', desc: 'Flexible payment options' }
            ];

            templatesContainer.innerHTML = templates.map(template => `
                <button onclick="showTemplate('${template.key}', '${template.title}')" class="text-left bg-accent/50 hover:bg-accent border border-border rounded-lg p-4 transition-all hover:shadow-md">
                    <div class="flex items-start gap-3">
                        <span class="text-2xl">${template.icon}</span>
                        <div class="flex-1">
                            <h4 class="font-semibold text-foreground mb-1">${template.title}</h4>
                            <p class="text-xs text-muted-foreground">${template.desc}</p>
                        </div>
                        <svg class="w-5 h-5 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </div>
                </button>
            `).join('');

            // Fetch and display permit paperwork
            fetchPaperwork(metadata.location, metadata.jobType);

            // Inspection checklist
            if (data.inspections) {
                displayInspectionChecklist(data.inspections, metadata.location, metadata.jobType);
            }

            // Requirements
            document.getElementById('requirementsContent').innerHTML = marked.parse(requirements);
        }

        function displayDataQuality(dataQuality) {
            const container = document.getElementById('dataQualityIndicator');

            if (!dataQuality) {
                container.innerHTML = '';
                return;
            }

            const isVerified = dataQuality.quality === 'verified';
            const isEstimated = dataQuality.quality === 'estimated';

            // Choose colors and icons based on quality level
            let bgColor, borderColor, iconColor, icon, badgeText, badgeColor;

            if (isVerified) {
                bgColor = 'bg-green-50';
                borderColor = 'border-green-200';
                iconColor = 'text-green-600';
                icon = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>`;
                badgeText = 'âœ“ Verified Data';
                badgeColor = 'bg-green-100 text-green-800 border-green-300';
            } else {
                // Estimated - show warning
                bgColor = 'bg-yellow-50';
                borderColor = 'border-yellow-200';
                iconColor = 'text-yellow-600';
                icon = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>`;
                badgeText = `âš  ${dataQuality.confidence === 'medium' ? 'Regional Estimate' : 'Estimated Data'}`;
                badgeColor = 'bg-yellow-100 text-yellow-800 border-yellow-300';
            }

            container.innerHTML = `
                <div class="${bgColor} border ${borderColor} rounded-lg p-4">
                    <div class="flex items-start gap-3">
                        <div class="${iconColor} flex-shrink-0 mt-0.5">
                            ${icon}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${badgeColor}">
                                    ${badgeText}
                                </span>
                                ${dataQuality.confidence ? `<span class="text-xs text-gray-600">Confidence: ${dataQuality.confidence.charAt(0).toUpperCase() + dataQuality.confidence.slice(1)}</span>` : ''}
                            </div>
                            <p class="text-sm text-gray-700 font-medium mb-1">
                                ${isVerified ? `Official data from ${dataQuality.source}` : `${dataQuality.source}`}
                            </p>
                            ${dataQuality.lastVerified ? `<p class="text-xs text-gray-600 mb-2">Last verified: ${new Date(dataQuality.lastVerified).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>` : ''}
                            ${dataQuality.notes ? `
                                <div class="mt-3 pt-3 border-t ${borderColor}">
                                    <p class="text-xs text-gray-700">
                                        <strong>${isVerified ? 'Note:' : 'âš ï¸ Important:'}</strong> ${dataQuality.notes}
                                    </p>
                                </div>
                            ` : ''}
                            ${isEstimated ? `
                                <div class="mt-3 pt-3 border-t ${borderColor} bg-yellow-100/50 rounded p-2">
                                    <p class="text-xs font-semibold text-yellow-900">
                                        ðŸ“ž Always verify fees with your local building department before quoting clients.
                                    </p>
                                </div>
                            ` : ''}
                            ${dataQuality.url ? `
                                <div class="mt-2">
                                    <a href="${dataQuality.url}" target="_blank" rel="noopener noreferrer" class="text-xs text-blue-600 hover:text-blue-800 hover:underline inline-flex items-center gap-1">
                                        View official source
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                        </svg>
                                    </a>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        async function fetchPaperwork(jurisdiction, jobType) {
            try {
                const response = await fetch(API_BASE + '/api/complete-paperwork-package', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ jurisdiction, jobType })
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch paperwork');
                }

                const paperwork = await response.json();

                if (!paperwork.success) {
                    displayNoPaperwork(jurisdiction, jobType);
                    return;
                }

                displayPaperwork(paperwork);
            } catch (error) {
                console.error('Error fetching paperwork:', error);
                displayNoPaperwork(jurisdiction, jobType);
            }
        }

        function displayPaperwork(paperwork) {
            // Badge
            document.getElementById('paperworkBadge').textContent = `${paperwork.totalForms} forms`;

            // Prep time estimate
            const prepTime = paperwork.estimatedPrepTime;
            document.getElementById('prepTimeEstimate').innerHTML = `
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-semibold text-foreground mb-1">Estimated Prep Time</p>
                        <p class="text-xs text-muted-foreground">${prepTime.note}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-2xl font-bold text-primary">${prepTime.estimatedHours}h</p>
                        <p class="text-xs text-muted-foreground">${prepTime.estimatedMinutes} minutes</p>
                    </div>
                </div>
            `;

            // Applications
            if (paperwork.applications.length > 0) {
                document.getElementById('paperworkApplications').innerHTML = `
                    <h4 class="text-sm font-semibold text-foreground mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Required Applications
                    </h4>
                    <div class="space-y-2">
                        ${paperwork.applications.map(form => `
                            <a href="${form.url}" target="_blank" rel="noopener noreferrer" class="block bg-accent/30 hover:bg-accent border border-border rounded-md p-3 transition-all hover:shadow-sm">
                                <div class="flex items-start justify-between gap-3">
                                    <div class="flex-1">
                                        <p class="font-semibold text-sm text-foreground mb-1">${form.formName}</p>
                                        ${form.formCode ? `<p class="text-xs text-muted-foreground mb-1">Form Code: ${form.formCode}</p>` : ''}
                                        <p class="text-xs text-muted-foreground">${form.description}</p>
                                        <div class="flex items-center gap-3 mt-2">
                                            ${form.isFillable ? '<span class="text-xs bg-success/20 text-success px-2 py-0.5 rounded">Fillable PDF</span>' : ''}
                                            ${form.lastVerified ? `<span class="text-xs text-muted-foreground">Verified: ${form.lastVerified}</span>` : ''}
                                        </div>
                                    </div>
                                    <svg class="w-5 h-5 text-primary flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                    </svg>
                                </div>
                            </a>
                        `).join('')}
                    </div>
                `;
            }

            // Supporting documents
            if (paperwork.supporting.length > 0) {
                document.getElementById('paperworkSupporting').innerHTML = `
                    <h4 class="text-sm font-semibold text-foreground mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Supporting Documents
                    </h4>
                    <div class="space-y-2">
                        ${paperwork.supporting.map(form => `
                            <a href="${form.url}" target="_blank" rel="noopener noreferrer" class="block bg-accent/30 hover:bg-accent border border-border rounded-md p-3 transition-all hover:shadow-sm">
                                <div class="flex items-start justify-between gap-3">
                                    <div class="flex-1">
                                        <p class="font-semibold text-sm text-foreground mb-1">${form.formName}</p>
                                        <p class="text-xs text-muted-foreground">${form.description}</p>
                                    </div>
                                    <svg class="w-5 h-5 text-primary flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                    </svg>
                                </div>
                            </a>
                        `).join('')}
                    </div>
                `;
            }

            // Fee schedules
            if (paperwork.feeSchedules.length > 0) {
                document.getElementById('paperworkFeeSchedules').innerHTML = `
                    <h4 class="text-sm font-semibold text-foreground mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Fee Schedules
                    </h4>
                    <div class="space-y-2">
                        ${paperwork.feeSchedules.map(form => `
                            <a href="${form.url}" target="_blank" rel="noopener noreferrer" class="block bg-accent/30 hover:bg-accent border border-border rounded-md p-3 transition-all hover:shadow-sm">
                                <div class="flex items-start justify-between gap-3">
                                    <div class="flex-1">
                                        <p class="font-semibold text-sm text-foreground mb-1">${form.formName}</p>
                                        <p class="text-xs text-muted-foreground">${form.description}</p>
                                        ${form.revisionDate ? `<p class="text-xs text-muted-foreground mt-1">Effective: ${form.revisionDate}</p>` : ''}
                                    </div>
                                    <svg class="w-5 h-5 text-primary flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                    </svg>
                                </div>
                            </a>
                        `).join('')}
                    </div>
                `;
            }

            // Tips
            if (paperwork.tips && paperwork.tips.length > 0) {
                document.getElementById('paperworkTips').innerHTML = `
                    <h4 class="text-sm font-semibold text-foreground mb-2 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                        Helpful Tips
                    </h4>
                    <ul class="space-y-2 text-sm text-foreground">
                        ${paperwork.tips.map(tip => `<li class="flex items-start gap-2"><span class="text-primary">â€¢</span><span>${tip}</span></li>`).join('')}
                    </ul>
                `;
            }

            // Store current paperwork for reporting
            window.currentPaperwork = paperwork;
        }

        function displayNoPaperwork(jurisdiction, jobType) {
            document.getElementById('paperworkBadge').textContent = 'Coming soon';
            document.getElementById('prepTimeEstimate').innerHTML = `
                <p class="text-sm text-muted-foreground">
                    Paperwork links for ${jobType} in ${jurisdiction} are not yet available. We're working on adding more jurisdictions!
                </p>
            `;
            document.getElementById('paperworkApplications').innerHTML = '';
            document.getElementById('paperworkSupporting').innerHTML = '';
            document.getElementById('paperworkFeeSchedules').innerHTML = '';
            document.getElementById('paperworkTips').innerHTML = `
                <p class="text-sm text-muted-foreground">
                    In the meantime, visit your local building department website to download required forms.
                </p>
            `;
        }

        function showReportLinkModal() {
            if (!window.currentPaperwork) {
                showError('No Data', 'No paperwork data available to report.');
                return;
            }

            const userEmail = prompt('Your email (optional):');
            const issue = prompt('What\'s the issue? (broken_link, outdated, wrong_form, or other):');
            const comments = prompt('Additional comments:');

            if (!issue) {
                return;
            }

            // Get the first form as an example (in a real implementation, you'd let user select which form)
            const forms = [...currentPaperwork.applications, ...currentPaperwork.supporting, ...currentPaperwork.feeSchedules];
            if (forms.length === 0) {
                showError('No Forms', 'No forms available to report.');
                return;
            }

            const form = forms[0];

            fetch(API_BASE + '/api/report-broken-link', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    jurisdiction: currentPaperwork.jurisdiction,
                    jobType: currentPaperwork.jobType,
                    formCode: form.formCode || 'N/A',
                    formName: form.formName,
                    userEmail,
                    issue,
                    comments
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showSuccess(`Report submitted (ID: ${data.reportId}). We'll review it within 48 hours.`);
                } else {
                    showError('Submission Failed', 'Could not submit your report. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error submitting report:', error);
                showError('Submission Failed', 'Could not submit your report. Please try again.');
            });
        }

        // Template modal functions
        function showTemplate(templateKey, templateTitle) {
            if (!currentData || !currentData.clientTemplates) return;

            const template = currentData.clientTemplates[templateKey];
            if (!template) return;

            currentTemplate = template;

            document.getElementById('modalTitle').textContent = templateTitle;
            document.getElementById('modalContent').value = template.body;
            document.getElementById('templateModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('templateModal').classList.add('hidden');
        }

        function copyTemplate() {
            const content = document.getElementById('modalContent').value;
            navigator.clipboard.writeText(content).then(() => {
                showSuccess('Template copied to clipboard!');
            });
        }

        function emailTemplate() {
            if (!currentTemplate) return;

            const subject = encodeURIComponent(currentTemplate.subject);
            const body = encodeURIComponent(currentTemplate.body);
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        }

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // ============================================
        // INSPECTION CHECKLIST
        // ============================================

        function getInspectionStorageKey(location, jobType) {
            return `permit-inspections-${location}-${jobType}`;
        }

        function displayInspectionChecklist(inspections, location, jobType) {
            const container = document.getElementById('inspectionChecklist');
            const storageKey = getInspectionStorageKey(location, jobType);
            const saved = JSON.parse(localStorage.getItem(storageKey) || '{}');

            container.innerHTML = inspections.map((inspection, i) => {
                const checked = saved[i] ? 'checked' : '';
                const completedClass = saved[i] ? 'bg-success/10 border-success/30' : 'bg-white';
                return `
                    <label class="flex items-center gap-3 p-3 border border-border rounded-md cursor-pointer transition-all hover:bg-accent/30 ${completedClass}" id="inspection-${i}">
                        <input type="checkbox" ${checked}
                            onchange="toggleInspection('${storageKey}', ${i}, ${inspections.length})"
                            class="w-5 h-5 rounded border-input text-success focus:ring-2 focus:ring-ring flex-shrink-0" />
                        <div class="flex-1">
                            <span class="text-sm font-medium text-foreground ${saved[i] ? 'line-through opacity-60' : ''}">${inspection}</span>
                            ${!saved[i] && i === Object.keys(saved).filter(k => saved[k]).length ? '<span class="ml-2 text-xs bg-primary text-primary-foreground px-2 py-0.5 rounded-full">Next up</span>' : ''}
                        </div>
                    </label>
                `;
            }).join('');

            updateInspectionProgress(storageKey, inspections.length);
        }

        function toggleInspection(storageKey, index, total) {
            const saved = JSON.parse(localStorage.getItem(storageKey) || '{}');
            saved[index] = !saved[index];
            localStorage.setItem(storageKey, JSON.stringify(saved));

            // Re-render to update styling
            if (currentData && currentData.inspections) {
                displayInspectionChecklist(currentData.inspections, currentData.metadata.location, currentData.metadata.jobType);
            }
        }

        function updateInspectionProgress(storageKey, total) {
            const saved = JSON.parse(localStorage.getItem(storageKey) || '{}');
            const completed = Object.values(saved).filter(Boolean).length;
            const percent = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('inspectionProgress').textContent = `${completed} / ${total}`;
            document.getElementById('inspectionProgressBar').style.width = `${percent}%`;

            if (completed === total && total > 0) {
                document.getElementById('inspectionProgress').textContent = `${completed} / ${total} - All passed!`;
                document.getElementById('inspectionProgress').classList.add('text-success');
            } else {
                document.getElementById('inspectionProgress').classList.remove('text-success');
            }
        }

        function printReport() {
            if (currentData) {
                document.getElementById('printMeta').textContent =
                    `${currentData.metadata.jobType} in ${currentData.metadata.location} | Generated ${new Date().toLocaleDateString()}`;
            }
            window.print();
        }

        function resetForm() {
            formCard.classList.remove('hidden');
            results.classList.add('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function emailResults() {
            if (currentData) {
                const subject = encodeURIComponent(`Permit Pricing: ${currentData.metadata.jobType} - ${currentData.metadata.location}`);
                const body = encodeURIComponent(`Permit pricing for ${currentData.metadata.jobType} in ${currentData.metadata.location}:\n\nRecommended charge: $${currentData.pricing.summary.recommendedCharge}\nYour profit: $${currentData.pricing.summary.yourProfit}\n\nView full details at Permit Assistant.`);
                window.location.href = `mailto:?subject=${subject}&body=${body}`;
            }
        }

        function copyToClipboard() {
            if (currentData) {
                const text = `Permit Pricing - ${currentData.metadata.jobType} in ${currentData.metadata.location}\n\nRecommended Charge: $${currentData.pricing.summary.recommendedCharge}\nYour Profit: $${currentData.pricing.summary.yourProfit}\nProfit Margin: ${currentData.pricing.summary.profitMargin}%\n\nPermit Fee: $${currentData.pricing.permitFee.permitFee}\nLabor Cost: $${currentData.pricing.labor.laborCost}\nTime Investment: ${currentData.pricing.summary.timeInvestment}\nProcessing Time: ${currentData.pricing.summary.processingTime}`;

                navigator.clipboard.writeText(text).then(() => {
                    showSuccess('Pricing copied to clipboard!');
                });
            }
        }

        // ============================================
        // SAVE / LOAD PROJECTS
        // ============================================

        const SAVED_PROJECTS_KEY = 'permit-assistant-saved-projects';

        function getSavedProjects() {
            try {
                return JSON.parse(localStorage.getItem(SAVED_PROJECTS_KEY) || '[]');
            } catch { return []; }
        }

        function saveCurrentProject() {
            if (!currentData) return;
            const projects = getSavedProjects();
            const project = {
                id: Date.now(),
                jobType: currentData.metadata.jobType,
                location: currentData.metadata.location,
                projectType: currentData.metadata.projectType,
                scope: currentData.metadata.scope,
                projectValue: currentData.metadata.projectValue,
                recommendedCharge: currentData.pricing.summary.recommendedCharge,
                savedAt: new Date().toISOString()
            };

            // Avoid exact duplicates
            const isDup = projects.some(p =>
                p.jobType === project.jobType &&
                p.location === project.location &&
                p.projectValue === project.projectValue
            );
            if (isDup) {
                const btn = document.getElementById('saveProjectBtn');
                btn.textContent = 'Already saved';
                setTimeout(() => {
                    btn.innerHTML = '<svg class="inline-block w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" /></svg>Save Lookup';
                }, 1500);
                return;
            }

            projects.unshift(project);
            // Keep max 20
            if (projects.length > 20) projects.length = 20;
            localStorage.setItem(SAVED_PROJECTS_KEY, JSON.stringify(projects));

            const btn = document.getElementById('saveProjectBtn');
            btn.innerHTML = '<svg class="inline-block w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>Saved!';
            setTimeout(() => {
                btn.innerHTML = '<svg class="inline-block w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" /></svg>Save Lookup';
            }, 1500);

            loadSavedProjects();
        }

        function loadSavedProjects() {
            const projects = getSavedProjects();
            const bar = document.getElementById('savedProjectsBar');
            const list = document.getElementById('savedProjectsList');

            if (projects.length === 0) {
                bar.classList.add('hidden');
                return;
            }

            bar.classList.remove('hidden');
            list.innerHTML = projects.map(p => {
                const parts = p.location.split(', ');
                const dateStr = new Date(p.savedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                return `<span class="saved-project-chip" onclick="loadProject(${p.id})" title="$${p.recommendedCharge} | ${dateStr}">
                    ${p.jobType} - ${parts[0]}, ${parts[1]}
                    <span class="delete-btn" onclick="event.stopPropagation(); deleteProject(${p.id})">&times;</span>
                </span>`;
            }).join('');
        }

        function loadProject(id) {
            const projects = getSavedProjects();
            const project = projects.find(p => p.id === id);
            if (!project) return;

            const parts = project.location.split(', ');
            document.getElementById('cityInput').value = project.location;
            document.getElementById('city').value = parts[0];
            document.getElementById('state').value = parts[1] || '';
            document.getElementById('jobType').value = getJobTypeSelectValue(project.jobType);
            document.getElementById('projectType').value = project.projectType || 'Residential';
            document.getElementById('scope').value = project.scope || 'New Installation';
            document.getElementById('projectValue').value = project.projectValue || 5000;

            // Show form and scroll to it
            formCard.classList.remove('hidden');
            results.classList.add('hidden');
            window.scrollTo({ top: formCard.offsetTop - 20, behavior: 'smooth' });

            // Auto-submit
            form.dispatchEvent(new Event('submit'));
        }

        function getJobTypeSelectValue(normalizedType) {
            const map = {
                'Electrical': 'Electrical Work',
                'Plumbing': 'Plumbing',
                'HVAC': 'HVAC',
                'Roofing': 'Roofing',
                'General Construction': 'General Construction',
                'Remodeling': 'Remodeling/Renovation',
                'Solar': 'Solar Installation',
                'Pool': 'Pool/Spa',
                'Fence': 'Fence/Deck',
                'Demolition': 'Demolition'
            };
            return map[normalizedType] || normalizedType;
        }

        function deleteProject(id) {
            const projects = getSavedProjects().filter(p => p.id !== id);
            localStorage.setItem(SAVED_PROJECTS_KEY, JSON.stringify(projects));
            loadSavedProjects();
        }

        function clearAllSavedProjects() {
            localStorage.removeItem(SAVED_PROJECTS_KEY);
            loadSavedProjects();
        }

        // ============================================
        // JURISDICTION COMPARISON FUNCTIONS
        // ============================================

        let availableJurisdictions = [];
        let selectedJurisdictions = [];

        // Toggle comparison panel
        function toggleComparison() {
            const panel = document.getElementById('comparisonPanel');
            const btn = document.getElementById('toggleComparisonBtn');
            const btnText = document.getElementById('toggleBtnText');
            const btnIcon = document.getElementById('toggleBtnIcon');

            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                panel.classList.add('animate-fade-in');
                btnText.textContent = 'Hide Comparison';
                btnIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />';
                btn.setAttribute('aria-expanded', 'true');

                // Load jurisdictions if not already loaded
                if (availableJurisdictions.length === 0) {
                    loadJurisdictions();
                }
            } else {
                panel.classList.add('hidden');
                btnText.textContent = 'Compare Cities';
                btnIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />';
                btn.setAttribute('aria-expanded', 'false');
            }
        }

        // Load available jurisdictions from API
        async function loadJurisdictions() {
            try {
                const response = await fetch(API_BASE + '/api/jurisdictions');
                const data = await response.json();

                if (data.success) {
                    availableJurisdictions = data.jurisdictions;
                    displayJurisdictionCheckboxes();
                }
            } catch (error) {
                console.error('Error loading jurisdictions:', error);
                showError('Loading Failed', 'Could not load jurisdictions. Please check your connection.');
            }
        }

        // Display jurisdiction checkboxes
        function displayJurisdictionCheckboxes() {
            const container = document.getElementById('jurisdictionCheckboxes');

            container.innerHTML = availableJurisdictions.map(j => `
                <label class="flex items-start gap-3 p-3 border border-border rounded-md hover:bg-accent/30 cursor-pointer transition-colors">
                    <input
                        type="checkbox"
                        value="${j.location}"
                        onchange="updateSelectedJurisdictions()"
                        class="mt-0.5 w-4 h-4 rounded border-input text-primary focus:ring-2 focus:ring-ring"
                    />
                    <div class="flex-1">
                        <div class="font-medium text-sm text-foreground">${j.city}</div>
                        <div class="text-xs text-muted-foreground">${j.state}</div>
                    </div>
                </label>
            `).join('');
        }

        // Update selected jurisdictions array
        function updateSelectedJurisdictions() {
            const checkboxes = document.querySelectorAll('#jurisdictionCheckboxes input[type="checkbox"]');
            selectedJurisdictions = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            // Update compare button state
            const compareBtn = document.getElementById('compareBtn');
            compareBtn.disabled = selectedJurisdictions.length < 2 || selectedJurisdictions.length > 5;
        }

        // Execute jurisdiction comparison
        async function compareJurisdictions() {
            const jobType = document.getElementById('comparisonJobType').value;

            if (!jobType) {
                showError('Missing Field', 'Please select a job type for comparison.');
                return;
            }

            if (selectedJurisdictions.length < 2) {
                showError('Not Enough Cities', 'Please select at least 2 jurisdictions to compare.');
                return;
            }

            if (selectedJurisdictions.length > 5) {
                showError('Too Many Cities', 'Please select no more than 5 jurisdictions.');
                return;
            }

            const compareBtn = document.getElementById('compareBtn');
            const originalText = compareBtn.innerHTML;
            compareBtn.disabled = true;
            compareBtn.innerHTML = '<div class="inline-block spinner" style="width:20px;height:20px;border-width:2px;"></div><span class="ml-2">Comparing...</span>';

            try {
                const response = await fetch(API_BASE + '/api/compare-jurisdictions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jurisdictions: selectedJurisdictions,
                        jobType: jobType
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayComparisonResults(data.comparison, data.differences, jobType);
                } else {
                    throw new Error(data.error || 'Comparison failed');
                }
            } catch (error) {
                console.error('Error comparing jurisdictions:', error);
                showError('Comparison Failed', 'Could not compare jurisdictions. Please try again.');
            } finally {
                compareBtn.disabled = false;
                compareBtn.innerHTML = originalText;
            }
        }

        // Display comparison results
        function displayComparisonResults(comparison, differences, jobType) {
            const resultsContainer = document.getElementById('comparisonResults');
            resultsContainer.classList.remove('hidden');

            const sorted = comparison.comparisons.sort((a, b) =>
                a.pricing.recommendedCharge - b.pricing.recommendedCharge
            );

            let html = `
                <div class="space-y-6">
                    <!-- Summary Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-accent/30 rounded-lg p-4">
                            <div class="text-sm text-muted-foreground mb-1">Lowest Charge</div>
                            <div class="text-2xl font-bold text-success">$${comparison.analysis.lowestRecommendedCharge}</div>
                            <div class="text-xs text-muted-foreground mt-1">${sorted[0].location}</div>
                        </div>
                        <div class="bg-accent/30 rounded-lg p-4">
                            <div class="text-sm text-muted-foreground mb-1">Average Charge</div>
                            <div class="text-2xl font-bold text-foreground">$${comparison.analysis.averageRecommendedCharge}</div>
                        </div>
                        <div class="bg-accent/30 rounded-lg p-4">
                            <div class="text-sm text-muted-foreground mb-1">Highest Charge</div>
                            <div class="text-2xl font-bold text-primary">$${comparison.analysis.highestRecommendedCharge}</div>
                            <div class="text-xs text-muted-foreground mt-1">${sorted[sorted.length-1].location}</div>
                        </div>
                    </div>

                    <!-- Key Differences -->
                    ${differences.length > 0 ? `
                        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                            <h4 class="font-semibold text-foreground mb-3 flex items-center gap-2">
                                <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                                Key Differences to Note
                            </h4>
                            <div class="space-y-2">
                                ${differences.map(diff => `
                                    <div class="flex items-start gap-2">
                                        <svg class="w-4 h-4 mt-0.5 flex-shrink-0 ${
                                            diff.severity === 'high' ? 'text-red-500' :
                                            diff.severity === 'medium' ? 'text-amber-500' :
                                            'text-blue-500'
                                        }" fill="currentColor" viewBox="0 0 20 20">
                                            <circle cx="10" cy="10" r="8"/>
                                        </svg>
                                        <div>
                                            <p class="text-sm font-medium text-foreground">${diff.message}</p>
                                            <p class="text-xs text-muted-foreground">${diff.details}</p>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Comparison Table -->
                    <div class="overflow-x-auto">
                        <h4 class="font-semibold text-foreground mb-4">Side-by-Side Comparison</h4>
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="border-b-2 border-border">
                                    <th class="text-left py-3 px-4 text-sm font-semibold text-foreground">Jurisdiction</th>
                                    <th class="text-right py-3 px-4 text-sm font-semibold text-foreground">Permit Fee</th>
                                    <th class="text-right py-3 px-4 text-sm font-semibold text-foreground">Your Charge</th>
                                    <th class="text-right py-3 px-4 text-sm font-semibold text-foreground">Your Profit</th>
                                    <th class="text-right py-3 px-4 text-sm font-semibold text-foreground">Margin</th>
                                    <th class="text-center py-3 px-4 text-sm font-semibold text-foreground">Processing</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sorted.map((comp, index) => {
                                    const isLowest = index === 0;
                                    const isHighest = index === sorted.length - 1;
                                    return `
                                        <tr class="border-b border-border hover:bg-accent/20 ${
                                            isLowest ? 'bg-success/10' :
                                            isHighest ? 'bg-primary/10' : ''
                                        }">
                                            <td class="py-3 px-4">
                                                <div class="font-medium text-foreground">${comp.location}</div>
                                                ${isLowest ? '<div class="text-xs text-success font-medium">â¬‡ Lowest</div>' : ''}
                                                ${isHighest ? '<div class="text-xs text-primary font-medium">â¬† Highest</div>' : ''}
                                            </td>
                                            <td class="text-right py-3 px-4 text-muted-foreground">$${comp.pricing.permitFee}</td>
                                            <td class="text-right py-3 px-4 font-semibold text-foreground">$${comp.pricing.recommendedCharge}</td>
                                            <td class="text-right py-3 px-4 text-success">$${comp.pricing.profit}</td>
                                            <td class="text-right py-3 px-4 text-muted-foreground">${comp.pricing.profitMargin}%</td>
                                            <td class="text-center py-3 px-4 text-xs text-muted-foreground">${comp.pricing.processingTime}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>

                    <!-- Variance Summary -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 class="font-semibold text-foreground mb-2">ðŸ’¡ Pricing Strategy Insight</h4>
                        <p class="text-sm text-muted-foreground">
                            The variance of <strong>$${comparison.analysis.variance}</strong> between jurisdictions means you could be
                            ${comparison.analysis.variance > 100 ? 'significantly undercharging' : 'pricing competitively'}
                            in some markets. Consider adjusting your rates based on local permit fees and processing complexity.
                        </p>
                    </div>
                </div>
            `;

            resultsContainer.innerHTML = html;
            resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    </script>
</body>
</html>
